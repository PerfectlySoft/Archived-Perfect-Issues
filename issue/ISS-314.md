# [ISS-314] Memory Leak in Perfect-CURL

[XML Source](./xml/ISS-314.xml)
<p><p>Hi All,</p>

<p>I recently discovered a memory leak in Perfect-CURL. At the end of each network request I was calling .reset() on the CURL object. I thought I was being a good citizen by doing this <img class="emoticon" src="http://jira.perfect.org:8080/images/icons/emoticons/tongue.png" height="16" width="16" align="absmiddle" alt="" border="0"/> but it turned out it was the cause of a massive memory leak.</p>

<p>To fix it, I tried calling .close() instead of .reset() and that fixed the memory leak. I also tried just using neither and that also fixed the memory leak. </p>

<p>I'm not sure what the intention of the reset command vs the close command is, but perhaps we should consider removing it since it seems to have no purpose? A new curl object could be allocated if we wanted it to be reset.</p>

<p>I was going to attach my instruments files that show each of the 3 options I mentioned above. However, they were gigantic (almost 1gb). I can provide sample code if needed. But basically, I was doing about 30 networking operations at once per user flow of the app. Thats where I could really see the memory leak.</p></p>





Status|Resolution|Reporter|Assignee
------|----------|--------|--------
Resolved|Done|[Jeffrey Bergier](jeffburg@jeffburg.com)|[Kyle Jessup]($kjessup)





Created|Tue, 1 Nov 2016 12:51:51 -0400
-------|--------------
Updated|Fri, 19 Jan 2018 13:50:34 -0500
Resolved|Fri, 19 Jan 2018 13:50:34 -0500


## Comments




### Tue, 1 Nov 2016 14:03:04 -0400 / rocky 

<p><p>Hi Jeffrey Bergier,</p>

<p>Would you like to share the code with me, please? </p>

<p>As far as I know, <tt>reset()</tt> means to clear the cURL object and reuse it while <tt>close()</tt> means to disable this object as the example code below:</p>

<p><tt>import cURL</tt><br/>
<tt>import PerfectCURL</tt></p>

<p><tt>let url = "https://hestiatv.domain.com/t/"</tt><br/>
<tt>let curl = CURL()</tt></p>

<p><tt>for _ in 1...5 {</tt><br/>
  <tt>let _ = curl.setOption(CURLOPT_URL, s: url)</tt><br/>
  <tt>let _ = curl.setOption(CURLOPT_USERAGENT, s: "CURL")</tt><br/>
  <tt>let (_, _, body ) = curl.performFully()</tt></p>

<p>  <tt>let content = String(bytes:body, encoding:String.Encoding.utf8)</tt></p>

<p>  <tt>print(content!)</tt><br/>
  <tt>curl.reset()</tt><br/>
  <tt>sleep(1)</tt><br/>
<tt>}</tt></p>



<p><tt>for _ in 1...5 {</tt><br/>
  <tt>let _ = curl.setOption(CURLOPT_URL, s: url)</tt><br/>
  <tt>let _ = curl.setOption(CURLOPT_USERAGENT, s: "CURL")</tt><br/>
  <tt>let (_, _, body ) = curl.performFully()</tt></p>

<p>  <tt>let content = String(bytes:body, encoding:String.Encoding.utf8)</tt></p>

<p>  <tt>print(content!)</tt><br/>
  <tt>curl.close()</tt><br/>
  <tt>sleep(1)</tt><br/>
<tt>}</tt></p>

<p>If I was correct, the above code should request a url and print six different timestamps then four blank lines followed because the object had been closed at the last four requests.</p>

<p>So according to the source code of Perfect-CURL, I would like to suggest to place a <tt>"defer { curl.close() }"</tt> immediately after the object initialization to clean the memory automatically. Then you can reset the curl object as many as you want to reuse this object in the same program.</p>

<p>If possible, please post the memory leak info in detail. </p>

<p>Thank you.</p>

<p>Warm regards,<br/>
– Rocky</p></p>


### Tue, 1 Nov 2016 15:05:45 -0400 / jeffburg@jeffburg.com 

<p><p>Hi, I built a small sample project thats similar to my usage. Its based on PerfectTemplate. It has 4 routes. Each corresponds to different commands on CURL. I was playing with it in Xcode with the memory panel open under the debug panel. It seems like all options leak. But close() leaks the least. reset() leaks a lot and reset(); close(); leaks just as much as reset. You can watch the memory usage and just refresh the browser page. <span class="nobr"><a href="http://jira.perfect.org:8080/secure/attachment/10218/10218_CURLLeak.zip" title="CURLLeak.zip attached to ISS-314">CURLLeak.zip<sup><img class="rendericon" src="http://jira.perfect.org:8080/images/icons/link_attachment_7.gif" height="7" width="7" align="absmiddle" alt="" border="0"/></sup></a></span> </p>

<p>One note, it will fail to build because the CURL class is not open and I subclassed it to print when the CURL object is deallocated. It seems to always be deallocated. But there is still a memory leak. In the Xcode project, you can change the curl object to be open class and then it will compile.</p></p>


### Tue, 1 Nov 2016 16:26:37 -0400 / rocky 

<p><p>Hi Jeffrey Bergier,</p>

<p>Thank you for describing your project. Unfortunately, I can't download your CURLLeak.zip file, so would you please upload it once more?</p>

<p>Anyway, I have used the Xcode Instrument to check the memory leak for the above code for both <tt>reset()</tt> &amp; <tt>close()</tt>, one minute, 30 url requests with <tt>reset()</tt> and 30 with <tt>close()</tt>, but still didn't find any leaks as attached.<br/>
 <span class="image-wrap" style=""><a id="10219_thumb" href="http://jira.perfect.org:8080/secure/attachment/10219/10219_Screen+Shot+2016-11-01+at+4.24.04+PM.png" title="Screen Shot 2016-11-01 at 4.24.04 PM.png" file-preview-type="image" file-preview-id="10219" file-preview-title="Screen Shot 2016-11-01 at 4.24.04 PM.png"><img src="http://jira.perfect.org:8080/secure/thumbnail/10219/_thumb_10219.png" style="border: 0px solid black" /></a></span> </p>

<p>So would you mind sharing more info with me? Thank you so much!</p>


<p>Warm regards,</p>

<p>– Rockford Wei</p></p>


### Tue, 1 Nov 2016 16:57:24 -0400 / jeffburg@jeffburg.com 

<p><p>Weird. I was able to redownload the zip. Well if you replace the main.swift file in PerfectTemplate with the following code (and add the CURL dependency) then you can replicate it. I also attached screenshot above. The one where the browser is at 127.0.0.1:8181/resetclose clearly leaks a lot more than 127.0.0.1:8181/close. /close May not be leaking at all. Its been hard to tell from my tests. But anything that calls reset is definitely leaking. This also may have to do with a difference between perform and performFully. I'm using perform.</p>


<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div class="error"><span class="error">Unable to find source-code formatter for language: swift.</span> Available languages are: actionscript, html, java, javascript, none, sql, xhtml, xml</div><pre><span class="code-comment">//
</span><span class="code-comment">//  main.swift
</span><span class="code-comment">//  PerfectTemplate
</span><span class="code-comment">//
</span><span class="code-comment">//  Created by Kyle Jessup on 2015-11-05.
</span><span class="code-comment">//	Copyright (C) 2015 PerfectlySoft, Inc.
</span><span class="code-comment">//
</span><span class="code-comment">//===----------------------------------------------------------------------===//
</span><span class="code-comment">//
</span><span class="code-comment">// This source file is part of the Perfect.org open source project
</span><span class="code-comment">//
</span><span class="code-comment">// Copyright (c) 2015 - 2016 PerfectlySoft Inc. and the Perfect project authors
</span><span class="code-comment">// Licensed under Apache License v2.0
</span><span class="code-comment">//
</span><span class="code-comment">// See http://perfect.org/licensing.html <span class="code-keyword">for</span> license information
</span><span class="code-comment">//
</span><span class="code-comment">//===----------------------------------------------------------------------===//
</span><span class="code-comment">//
</span>
<span class="code-keyword">import</span> PerfectLib
<span class="code-keyword">import</span> PerfectHTTP
<span class="code-keyword">import</span> PerfectHTTPServer
<span class="code-keyword">import</span> PerfectCURL
<span class="code-keyword">import</span> cURL

let numberRequests = 100

class DeinitCURL: CURL {
    deinit {
        print(<span class="code-quote">"removing CURL request from memory"</span>)
    }
}

extension DeinitCURL {
    convenience init(completion: @escaping(Int, [UInt8], [UInt8], CURL) -&gt; <span class="code-object">Void</span>) {
        self.init()
        self.url = <span class="code-quote">"https:<span class="code-comment">//www.google.com"</span>
</span>        self.setOption(CURLOPT_TIMEOUT, <span class="code-object">int</span>: 1) <span class="code-comment">// set the timeout to 5 seconds
</span>        self.perform() { tuple in
            completion(tuple.0, tuple.1, tuple.2, self)
        }
    }
}


<span class="code-comment">// Create HTTP server.
</span>let server = HTTPServer()


<span class="code-comment">// Register your own routes and handlers
</span><span class="code-keyword">var</span> routes = Routes()
routes.add(method: .get, uri: <span class="code-quote">"/reset"</span>, handler: { request, response in
    response.setHeader(.contentType, value: <span class="code-quote">"text/html"</span>)
    response.appendBody(string: <span class="code-quote">"&lt;html&gt;&lt;title&gt;Hello, world!&lt;/title&gt;&lt;body&gt;Hello, world!&lt;/body&gt;&lt;/html&gt;"</span>)
    response.completed()
    <span class="code-keyword">for</span> i in 0 ..&lt; numberRequests {
        let request = DeinitCURL(completion: { (code, header, body, returnedCURLObject) in
            returnedCURLObject.reset()
        })
    }
})

routes.add(method: .get, uri: <span class="code-quote">"/resetclose"</span>, handler: { request, response in
    response.setHeader(.contentType, value: <span class="code-quote">"text/html"</span>)
    response.appendBody(string: <span class="code-quote">"&lt;html&gt;&lt;title&gt;Hello, world!&lt;/title&gt;&lt;body&gt;Hello, world!&lt;/body&gt;&lt;/html&gt;"</span>)
    response.completed()
    <span class="code-keyword">for</span> i in 0 ..&lt; numberRequests {
        let request = DeinitCURL(completion: { (code, header, body, returnedCURLObject) in
            returnedCURLObject.reset()
            returnedCURLObject.close()
        })
    }
})

routes.add(method: .get, uri: <span class="code-quote">"/close"</span>, handler: { request, response in
    response.setHeader(.contentType, value: <span class="code-quote">"text/html"</span>)
    response.appendBody(string: <span class="code-quote">"&lt;html&gt;&lt;title&gt;Hello, world!&lt;/title&gt;&lt;body&gt;Hello, world!&lt;/body&gt;&lt;/html&gt;"</span>)
    response.completed()
    <span class="code-keyword">for</span> i in 0 ..&lt; numberRequests {
        let request = DeinitCURL(completion: { (code, header, body, returnedCURLObject) in
            returnedCURLObject.close()
        })
    }
})

routes.add(method: .get, uri: <span class="code-quote">"/nothing"</span>, handler: { request, response in
    response.setHeader(.contentType, value: <span class="code-quote">"text/html"</span>)
    response.appendBody(string: <span class="code-quote">"&lt;html&gt;&lt;title&gt;Hello, world!&lt;/title&gt;&lt;body&gt;Hello, world!&lt;/body&gt;&lt;/html&gt;"</span>)
    response.completed()
    <span class="code-keyword">for</span> i in 0 ..&lt; numberRequests {
        let request = DeinitCURL(completion: { (code, header, body, returnedCURLObject) in
            <span class="code-comment">// <span class="code-keyword">do</span> nothing
</span>        })
    }
})

<span class="code-comment">// Add the routes to the server.
</span>server.addRoutes(routes)

<span class="code-comment">// Set a listen port of 8181
</span>server.serverPort = 8181

<span class="code-comment">// Set a document root.
</span><span class="code-comment">// This is optional. If you <span class="code-keyword">do</span> not want to serve <span class="code-keyword">static</span> content then <span class="code-keyword">do</span> not set <span class="code-keyword">this</span>.
</span><span class="code-comment">// Setting the document root will automatically add a <span class="code-keyword">static</span> file handler <span class="code-keyword">for</span> the route /**
</span>server.documentRoot = <span class="code-quote">"./webroot"</span>

<span class="code-comment">// Gather command line options and further configure the server.
</span><span class="code-comment">// Run the server with --help to see the list of supported arguments.
</span><span class="code-comment">// Command line arguments will supplant any of the values set above.
</span>configureServer(server)

<span class="code-keyword">do</span> {
	<span class="code-comment">// Launch the HTTP server.
</span>	<span class="code-keyword">try</span> server.start()
} <span class="code-keyword">catch</span> PerfectError.networkError(let err, let msg) {
	print(<span class="code-quote">"Network error thrown: \(err) \(msg)"</span>)
}

</pre>
</div></div></p>


### Tue, 1 Nov 2016 17:13:41 -0400 / rocky 

<p><p>Hi Jeffrey Bergier,</p>

<p>Thank you for sharing these codes and screen shots! </p>

<p>However, please NOTE that the first tuple $0 of <tt>perform()</tt> indicates whether the current curl request is completed or not, and in most cases a while($0) waiting is strongly recommended because if run <tt>reset()</tt> method immediately even before it's done, it possibly would cause something unexpected. </p>

<p>If you don't mind, I would like to rewrite this server with similar function later. </p>

<p>Best, <br/>
– Rockford Wei</p></p>


### Tue, 1 Nov 2016 17:35:59 -0400 / jeffburg@jeffburg.com 

<p><p>Hi Rockford,</p>

<p>Thanks for looking into this. I just took a look at the function signature and now I see what you're seeing. There are two perform() functions. One returns a Bool that indicates whether the request is done or not and the other doesn't. The function I was using is:</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div class="error"><span class="error">Unable to find source-code formatter for language: swift.</span> Available languages are: actionscript, html, java, javascript, none, sql, xhtml, xml</div><pre><span class="code-comment">/// Perform the CURL request in a non-blocking manner. The closure will be called with the resulting code, header and body data.
</span><span class="code-keyword">public</span> func perform(closure: @escaping (Int, [UInt8], [UInt8]) -&gt; ()) { ... }
</pre>
</div></div>

<p>and just to make sure I was calling into the right function I altered my code to make sure Swift had all the right types in the callback.</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<div class="error"><span class="error">Unable to find source-code formatter for language: swift.</span> Available languages are: actionscript, html, java, javascript, none, sql, xhtml, xml</div><pre>extension DeinitCURL {
    convenience init(completion: @escaping(Int, [UInt8], [UInt8], CURL) -&gt; <span class="code-object">Void</span>) {
        self.init()
        self.url = <span class="code-quote">"https:<span class="code-comment">//www.google.com"</span>
</span>        self.setOption(CURLOPT_TIMEOUT, <span class="code-object">int</span>: 1) <span class="code-comment">// set the timeout to 5 seconds
</span>        self.perform() { (code: Int, header: [UInt8], body: [UInt8]) in
            completion(code, header, body, self)
        }
    }
}
</pre>
</div></div>

<p>So it doesn't seem like this really simple code example is doing anything to reset requests mid flight. The perform() without the Bool should only be called when the request is fully complete right?</p>

<p>It sounds like you all have this on the chopping block for an improved API later. Maybe for now, I'll just use performFully() and do the threading myself with PerfectThread. Let me know what you think.</p>

<p>-Jeff</p></p>


### Tue, 1 Nov 2016 17:47:31 -0400 / jeffburg@jeffburg.com 

<p><p>Sorry to be a bother again. I just tried a similar 4 function test with manual threading using only performFully() and it seems to have the same problem. You can see the memory chart for /manual/resetclose and main.swift file is pasted below:</p>


<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-comment">//
</span><span class="code-comment">//  main.swift
</span><span class="code-comment">//  PerfectTemplate
</span><span class="code-comment">//
</span><span class="code-comment">//  Created by Kyle Jessup on 2015-11-05.
</span><span class="code-comment">//	Copyright (C) 2015 PerfectlySoft, Inc.
</span><span class="code-comment">//
</span><span class="code-comment">//===----------------------------------------------------------------------===//
</span><span class="code-comment">//
</span><span class="code-comment">// This source file is part of the Perfect.org open source project
</span><span class="code-comment">//
</span><span class="code-comment">// Copyright (c) 2015 - 2016 PerfectlySoft Inc. and the Perfect project authors
</span><span class="code-comment">// Licensed under Apache License v2.0
</span><span class="code-comment">//
</span><span class="code-comment">// See http://perfect.org/licensing.html <span class="code-keyword">for</span> license information
</span><span class="code-comment">//
</span><span class="code-comment">//===----------------------------------------------------------------------===//
</span><span class="code-comment">//
</span>
<span class="code-keyword">import</span> PerfectLib
<span class="code-keyword">import</span> PerfectHTTP
<span class="code-keyword">import</span> PerfectHTTPServer
<span class="code-keyword">import</span> PerfectCURL
<span class="code-keyword">import</span> cURL
<span class="code-keyword">import</span> PerfectThread

class DeinitCURL: CURL {
    deinit {
        print(<span class="code-quote">"removing CURL request from memory"</span>)
    }
}

extension DeinitCURL {
    convenience init(completion: @escaping(Int, [UInt8], [UInt8], CURL) -&gt; <span class="code-object">Void</span>) {
        self.init()
        self.url = <span class="code-quote">"https:<span class="code-comment">//www.google.com"</span>
</span>        self.setOption(CURLOPT_TIMEOUT, <span class="code-object">int</span>: 1) <span class="code-comment">// set the timeout to 5 seconds
</span>        self.perform() { (code: Int, header: [UInt8], body: [UInt8]) in
            completion(code, header, body, self)
        }
    }
}


<span class="code-comment">// Create HTTP server.
</span>let server = HTTPServer()

let numberRequests = 100

<span class="code-comment">// Register your own routes and handlers
</span><span class="code-keyword">var</span> routes = Routes()

routes.add(method: .get, uri: <span class="code-quote">"/manual/close"</span>, handler: { request, response in
    response.setHeader(.contentType, value: <span class="code-quote">"text/html"</span>)
    response.appendBody(string: <span class="code-quote">"&lt;html&gt;&lt;title&gt;Hello, world!&lt;/title&gt;&lt;body&gt;Hello, world!&lt;/body&gt;&lt;/html&gt;"</span>)
    response.completed()
    <span class="code-keyword">for</span> i in 0 ..&lt; numberRequests {
        let request = DeinitCURL(url: <span class="code-quote">"https:<span class="code-comment">//www.google.com"</span>)
</span>        request.setOption(CURLOPT_TIMEOUT, <span class="code-object">int</span>: 1)
        Threading.getQueue(name: <span class="code-quote">"Networking"</span>, type: .concurrent).dispatch {
            request.performFully()
            request.close()
        }
    }
})

routes.add(method: .get, uri: <span class="code-quote">"/manual/nothing"</span>, handler: { request, response in
    response.setHeader(.contentType, value: <span class="code-quote">"text/html"</span>)
    response.appendBody(string: <span class="code-quote">"&lt;html&gt;&lt;title&gt;Hello, world!&lt;/title&gt;&lt;body&gt;Hello, world!&lt;/body&gt;&lt;/html&gt;"</span>)
    response.completed()
    <span class="code-keyword">for</span> i in 0 ..&lt; numberRequests {
        let request = DeinitCURL(url: <span class="code-quote">"https:<span class="code-comment">//www.google.com"</span>)
</span>        request.setOption(CURLOPT_TIMEOUT, <span class="code-object">int</span>: 1)
        Threading.getQueue(name: <span class="code-quote">"Networking"</span>, type: .concurrent).dispatch {
            request.performFully()
        }
    }
})

routes.add(method: .get, uri: <span class="code-quote">"/manual/reset"</span>, handler: { request, response in
    response.setHeader(.contentType, value: <span class="code-quote">"text/html"</span>)
    response.appendBody(string: <span class="code-quote">"&lt;html&gt;&lt;title&gt;Hello, world!&lt;/title&gt;&lt;body&gt;Hello, world!&lt;/body&gt;&lt;/html&gt;"</span>)
    response.completed()
    <span class="code-keyword">for</span> i in 0 ..&lt; numberRequests {
        let request = DeinitCURL(url: <span class="code-quote">"https:<span class="code-comment">//www.google.com"</span>)
</span>        request.setOption(CURLOPT_TIMEOUT, <span class="code-object">int</span>: 1)
        Threading.getQueue(name: <span class="code-quote">"Networking"</span>, type: .concurrent).dispatch {
            request.performFully()
            request.reset()
        }
    }
})

routes.add(method: .get, uri: <span class="code-quote">"/manual/resetclose"</span>, handler: { request, response in
    response.setHeader(.contentType, value: <span class="code-quote">"text/html"</span>)
    response.appendBody(string: <span class="code-quote">"&lt;html&gt;&lt;title&gt;Hello, world!&lt;/title&gt;&lt;body&gt;Hello, world!&lt;/body&gt;&lt;/html&gt;"</span>)
    response.completed()
    <span class="code-keyword">for</span> i in 0 ..&lt; numberRequests {
        let request = DeinitCURL(url: <span class="code-quote">"https:<span class="code-comment">//www.google.com"</span>)
</span>        request.setOption(CURLOPT_TIMEOUT, <span class="code-object">int</span>: 1)
        Threading.getQueue(name: <span class="code-quote">"Networking"</span>, type: .concurrent).dispatch {
            request.performFully()
            request.reset()
            request.close()
        }
    }
})


routes.add(method: .get, uri: <span class="code-quote">"/reset"</span>, handler: { request, response in
    response.setHeader(.contentType, value: <span class="code-quote">"text/html"</span>)
    response.appendBody(string: <span class="code-quote">"&lt;html&gt;&lt;title&gt;Hello, world!&lt;/title&gt;&lt;body&gt;Hello, world!&lt;/body&gt;&lt;/html&gt;"</span>)
    response.completed()
    <span class="code-keyword">for</span> i in 0 ..&lt; numberRequests {
        let request = DeinitCURL(completion: { (code, header, body, returnedCURLObject) in
            returnedCURLObject.reset()
        })
    }
})

routes.add(method: .get, uri: <span class="code-quote">"/resetclose"</span>, handler: { request, response in
    response.setHeader(.contentType, value: <span class="code-quote">"text/html"</span>)
    response.appendBody(string: <span class="code-quote">"&lt;html&gt;&lt;title&gt;Hello, world!&lt;/title&gt;&lt;body&gt;Hello, world!&lt;/body&gt;&lt;/html&gt;"</span>)
    response.completed()
    <span class="code-keyword">for</span> i in 0 ..&lt; numberRequests {
        let request = DeinitCURL(completion: { (code, header, body, returnedCURLObject) in
            returnedCURLObject.reset()
            returnedCURLObject.close()
        })
    }
})

routes.add(method: .get, uri: <span class="code-quote">"/close"</span>, handler: { request, response in
    response.setHeader(.contentType, value: <span class="code-quote">"text/html"</span>)
    response.appendBody(string: <span class="code-quote">"&lt;html&gt;&lt;title&gt;Hello, world!&lt;/title&gt;&lt;body&gt;Hello, world!&lt;/body&gt;&lt;/html&gt;"</span>)
    response.completed()
    <span class="code-keyword">for</span> i in 0 ..&lt; numberRequests {
        let request = DeinitCURL(completion: { (code, header, body, returnedCURLObject) in
            returnedCURLObject.close()
        })
    }
})

routes.add(method: .get, uri: <span class="code-quote">"/nothing"</span>, handler: { request, response in
    response.setHeader(.contentType, value: <span class="code-quote">"text/html"</span>)
    response.appendBody(string: <span class="code-quote">"&lt;html&gt;&lt;title&gt;Hello, world!&lt;/title&gt;&lt;body&gt;Hello, world!&lt;/body&gt;&lt;/html&gt;"</span>)
    response.completed()
    <span class="code-keyword">for</span> i in 0 ..&lt; numberRequests {
        let request = DeinitCURL(completion: { (code, header, body, returnedCURLObject) in
            <span class="code-comment">// <span class="code-keyword">do</span> nothing
</span>        })
    }
})

<span class="code-comment">// Add the routes to the server.
</span>server.addRoutes(routes)

<span class="code-comment">// Set a listen port of 8181
</span>server.serverPort = 8181

<span class="code-comment">// Set a document root.
</span><span class="code-comment">// This is optional. If you <span class="code-keyword">do</span> not want to serve <span class="code-keyword">static</span> content then <span class="code-keyword">do</span> not set <span class="code-keyword">this</span>.
</span><span class="code-comment">// Setting the document root will automatically add a <span class="code-keyword">static</span> file handler <span class="code-keyword">for</span> the route /**
</span>server.documentRoot = <span class="code-quote">"./webroot"</span>

<span class="code-comment">// Gather command line options and further configure the server.
</span><span class="code-comment">// Run the server with --help to see the list of supported arguments.
</span><span class="code-comment">// Command line arguments will supplant any of the values set above.
</span>configureServer(server)

<span class="code-keyword">do</span> {
	<span class="code-comment">// Launch the HTTP server.
</span>	<span class="code-keyword">try</span> server.start()
} <span class="code-keyword">catch</span> PerfectError.networkError(let err, let msg) {
	print(<span class="code-quote">"Network error thrown: \(err) \(msg)"</span>)
}

</pre>
</div></div></p>


### Wed, 2 Nov 2016 12:21:17 -0400 / rocky 

<p><p>Hi Jeffrey,</p>

<p>Thank you for updating your issue! Would you like to try the code below? <br/>
This server generates two different routes: </p>
<ul>
	<li><tt>/</tt>   &#8211;  a page that collects external URLs concurrently. It will dispatch 32 threads and wait them all, then join the results to display. Usually 2~3 seconds it will return.</li>
	<li><tt>/liner</tt> &#8211;  the same as <tt>/</tt> but requesting per url one by one without threading, just for comparing the sequential result.  Maybe will take 20+ seconds.</li>
</ul>


<p>Unfortunately up to now the Threading.join() method is still under developing, so I used a quick dirty trick to wait all threads in a time, sorry about that.</p>

<p>Hope you can share the same experience with me! Thank you!</p>

<p>Warm,<br/>
Rocky</p>

<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-comment">//
</span><span class="code-comment">//  main.swift
</span><span class="code-comment">//  PerfectTemplate
</span><span class="code-comment">//
</span><span class="code-comment">//  Created by Kyle Jessup on 2015-11-05.
</span><span class="code-comment">//	Copyright (C) 2015 PerfectlySoft, Inc.
</span><span class="code-comment">//
</span><span class="code-comment">//===----------------------------------------------------------------------===//
</span><span class="code-comment">//
</span><span class="code-comment">// This source file is part of the Perfect.org open source project
</span><span class="code-comment">//
</span><span class="code-comment">// Copyright (c) 2015 - 2016 PerfectlySoft Inc. and the Perfect project authors
</span><span class="code-comment">// Licensed under Apache License v2.0
</span><span class="code-comment">//
</span><span class="code-comment">// See http://perfect.org/licensing.html <span class="code-keyword">for</span> license information
</span><span class="code-comment">//
</span><span class="code-comment">//===----------------------------------------------------------------------===//
</span><span class="code-comment">//
</span>
<span class="code-keyword">import</span> PerfectLib
<span class="code-keyword">import</span> PerfectHTTP
<span class="code-keyword">import</span> PerfectHTTPServer
<span class="code-keyword">import</span> PerfectCURL
<span class="code-keyword">import</span> cURL
<span class="code-keyword">import</span> PerfectThread

<span class="code-comment">// Create HTTP server.
</span>let server = HTTPServer()

<span class="code-keyword">public</span> func ping () -&gt; <span class="code-object">String</span> {
	let curl = CURL(url:<span class="code-quote">"http:<span class="code-comment">//hestiatv.domain.com/t/"</span>)
</span>	defer {
		curl.close()
	}
	let (_, _, body ) = curl.performFully()
  let content = <span class="code-object">String</span>(bytes:body, encoding:<span class="code-object">String</span>.Encoding.utf8)
	<span class="code-keyword">return</span> content!
}

<span class="code-comment">// Register your own routes and handlers
</span><span class="code-keyword">var</span> routes = Routes()
routes.add(method: .get, uri: <span class="code-quote">"/liner"</span>, handler: {
		request, response in
		let tm = time(nil)
		<span class="code-keyword">var</span> collector = [<span class="code-object">String</span>]()
		<span class="code-keyword">for</span> _ in 1...32 {
			let result = ping()
			collector.append(result)
		}
		let delay = time(nil) - tm
		let total = collector.count
		let content = collector.reduce("", +)
		response.setHeader(.contentType, value: <span class="code-quote">"text/html"</span>)
		response.appendBody(string: <span class="code-quote">"&lt;html&gt;&lt;title&gt;Hello, world!&lt;/title&gt;&lt;body&gt;&lt;H1&gt;\(total) URL requests in Queue: \(delay) Seconds&lt;/H1&gt;&lt;p&gt;\(content)&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;"</span>)
		response.completed()
}) <span class="code-comment">//end add
</span>
routes.add(method: .get, uri: <span class="code-quote">"/"</span>, handler: {
		request, response in
		let tm = time(nil)
		<span class="code-keyword">var</span> collector = [<span class="code-object">String</span>]()

		let mylock = Threading.Lock()

		<span class="code-keyword">for</span> _ in 1...32 {
			Threading.getQueue(name: <span class="code-quote">"Networking"</span>, type: .concurrent).dispatch {
				let result = ping()
				mylock.doWithLock {
					collector.append(result)
				}
			}
		}
		<span class="code-keyword">while</span>(collector.count &lt; 31) {
			sleep(1)
		}
		let delay = time(nil) - tm
		let total = collector.count
		let content = collector.reduce("", +)
		response.setHeader(.contentType, value: <span class="code-quote">"text/html"</span>)
		response.appendBody(string: <span class="code-quote">"&lt;html&gt;&lt;title&gt;Hello, world!&lt;/title&gt;&lt;body&gt;&lt;H1&gt;\(total) URL requests Concurrently: \(delay) Seconds&lt;/H1&gt;&lt;p&gt;\(content)&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;"</span>)
		response.completed()
}) <span class="code-comment">//end add
</span>
<span class="code-comment">// Add the routes to the server.
</span>server.addRoutes(routes)

<span class="code-comment">// Set a listen port of 8181
</span>server.serverPort = 8181

<span class="code-comment">// Set a document root.
</span><span class="code-comment">// This is optional. If you <span class="code-keyword">do</span> not want to serve <span class="code-keyword">static</span> content then <span class="code-keyword">do</span> not set <span class="code-keyword">this</span>.
</span><span class="code-comment">// Setting the document root will automatically add a <span class="code-keyword">static</span> file handler <span class="code-keyword">for</span> the route /**
</span>server.documentRoot = <span class="code-quote">"./webroot"</span>

<span class="code-comment">// Gather command line options and further configure the server.
</span><span class="code-comment">// Run the server with --help to see the list of supported arguments.
</span><span class="code-comment">// Command line arguments will supplant any of the values set above.
</span>configureServer(server)

<span class="code-keyword">do</span> {
	<span class="code-comment">// Launch the HTTP server.
</span>	<span class="code-keyword">try</span> server.start()
} <span class="code-keyword">catch</span> PerfectError.networkError(let err, let msg) {
	print(<span class="code-quote">"Network error thrown: \(err) \(msg)"</span>)
}
</pre>
</div></div></p>


### Wed, 2 Nov 2016 13:30:10 -0400 / jeffburg@jeffburg.com 

<p><p>Hi Rockford,</p>

<p>I tried it. It looks like a nifty solution for keeping track of when all the requests finish. But the class I'm using already does that. I'm more worried about the memory leaks. That said, I tried this code and it definitely appears to leak less. Each refresh causes less of a spike. But I attached a new screenshot above. It still looks like its leaking memory to me. Also, I tried a bunch of different methods in the defer {} block in the code you provided. reset(), close(), reset(); close(); nothing, etc. It seemed to make no difference to the rate of leaking.</p>

<p>I think there are two primary issues. </p>

<ul class="alternate" type="square">
	<li>1) those two methods don't really make sense. Either separately or together. They seem like a relic of the C API. Close() is called when the CURL object is being deallocated, so that should happen automatically. Reset should be achieved by creating a new CURL object.</li>
	<li>I understand this is a matter of opinion, so we can ignore this for now</li>
	<li>2) There seems to be a fundamental problem with the memory used by this object. I tried looking through it myself, but I'm just not experienced enough when it comes to UnsafeMutablePointers and allocating and reallocating memory. But it seems like that is where the problem is. There are no retain cycles, Swift is deallocating the CURL objects, but some of the memory allocated by the CURL objects is not being deallocated.</li>
</ul>


<p>Let me know what you think.</p>

<p>-Jeff</p></p>


### Wed, 2 Nov 2016 15:36:14 -0400 / rocky 

<p><p>Hi Jeffrey,</p>

<p>I simplified my sample code with using a single CURL of <tt>reset</tt> in a multi-thread context and found no leaks for several minutes, so I don't think what happened to you is irrelevant to perfect CURL or Threading.</p>

<p>However, I will keep watching the PerfectTemplate itself, or if you found any discoveries, please don't hesitate to share.</p>

<p>Thank you so much, you are so thoughtful!</p>

<p>Best,<br/>
– Rocky</p>
<div class="code panel" style="border-width: 1px;"><div class="codeContent panelContent">
<pre class="code-java"><span class="code-keyword">import</span> cURL
<span class="code-keyword">import</span> PerfectCURL
<span class="code-keyword">import</span> PerfectThread

let curl = CURL()
let mylock = Threading.Lock()


func agent () {
		<span class="code-keyword">var</span> collector = [Int]()

		<span class="code-keyword">for</span> _ in 1...32 {
			Threading.getQueue(name: <span class="code-quote">"Networking"</span>, type: .concurrent).dispatch {

				mylock.doWithLock {
            let _ = curl.reset()
            let _ = curl.setOption(CURLOPT_URL, s:<span class="code-quote">"http:<span class="code-comment">//hestiatv.domain.com/t/"</span>)
</span>            let (_, _, body ) = curl.performFully()
            collector.append(body.count)
				}<span class="code-comment">//end Lock
</span>			}<span class="code-comment">//end dispatch
</span>		}
		<span class="code-keyword">while</span>(collector.count &lt; 32) {
			sleep(1)
		}<span class="code-comment">//end wait
</span>		print(collector.count)
}

<span class="code-keyword">while</span>(<span class="code-keyword">true</span>) {
  agent()
}

</pre>
</div></div>
<p> <span class="image-wrap" style=""><a id="10226_thumb" href="http://jira.perfect.org:8080/secure/attachment/10226/10226_Screen+Shot+2016-11-02+at+3.28.39+PM.png" title="Screen Shot 2016-11-02 at 3.28.39 PM.png" file-preview-type="image" file-preview-id="10226" file-preview-title="Screen Shot 2016-11-02 at 3.28.39 PM.png"><img src="http://jira.perfect.org:8080/secure/thumbnail/10226/_thumb_10226.png" style="border: 0px solid black" /></a></span></p></p>


### Wed, 2 Nov 2016 15:38:16 -0400 / jeffburg@jeffburg.com 

<p><p>Thanks Rocky,</p>

<p>I'll take a look at my implementation and see if I can reduce the number of CURL objects I create. </p>

<p>Thanks for all your help,<br/>
-Jeff</p></p>


### Wed, 2 Nov 2016 16:01:14 -0400 / rocky 

<p><p>Hi Jeffrey Bergier,</p>

<p>Thank you for your patience! Yes, finally I confirm that it was an existing bug of PerfectTemplate itself. If you don't mind, I would like to close the current issue and create a more specific new issue instead. Again, both Perfect-Thread and Perfect-CURL are very cool &amp; safe libraries and you can use them without any worries.</p>

<p>Thank you for your great contribution!</p>

<p>Sincerely Yours,<br/>
– Rockford Wei</p></p>


### Wed, 2 Nov 2016 16:56:24 -0400 / jeffburg@jeffburg.com 

<p><p>Oh, its a bug in perfect template? Can you link to that bug here. I use perfect template code as the starting point for my project. So I want to make sure I make the same fix <img class="emoticon" src="http://jira.perfect.org:8080/images/icons/emoticons/smile.png" height="16" width="16" align="absmiddle" alt="" border="0"/></p></p>


### Wed, 2 Nov 2016 17:00:06 -0400 / rocky 

<p><p>Hi Jeffrey Bergier,</p>

<p>Yes, we are locating and fixing the bug right now, so you can follow  <a href="http://jira.perfect.org:8080/browse/ISS-315" title="PerfectTemplate Memory Leak" class="issue-link" data-issue-key="ISS-315"><del>ISS-315</del></a> for updates.</p>

<p>Thank you!.</p>

<p>– Rockford Wei</p></p>


### Wed, 2 Nov 2016 17:01:12 -0400 / rocky 

<p><p>Hi Jeffrey Bergier,</p>

<p>Thank you for your contribution, now this issue was move to <a href="http://jira.perfect.org:8080/browse/ISS-315" title="PerfectTemplate Memory Leak" class="issue-link" data-issue-key="ISS-315"><del>ISS-315</del></a>. </p>

<p>– Rockford Wei</p></p>


### Tue, 8 Nov 2016 09:28:58 -0500 / rocky 

<p><p>Reopened as requested by customer, Jeffrey Bergier, although neither PerfectTemplate nor CURL/Threading was found with actual memory leaks, which were misreported by Instruments of Xcode.</p></p>


### Tue, 7 Mar 2017 15:48:38 -0500 / thomascalmon 

<p><p>Hi guys.</p>

<p>I'm facing a lot of memory leaks when using CURL. I need doing about 35k synchronous requests, memory usage starts in ~8mb and finishes higher than ~60mb (max in ~85mb).</p>

<p>Prints attached!</p>

<p>Cheers.</p></p>


### Tue, 7 Mar 2017 19:33:57 -0500 / kjessup 

<p><p>OK can you do your test again with the newer version I pushed? I tagged it as 2.0.5. </p></p>


### Wed, 8 Mar 2017 09:30:00 -0500 / thomascalmon 

<p><p>Well, memory leaks have stoped!<br/>
Thanks so much.</p></p>

## Attachments





Id|Name
------|------------
10218|[CURLLeak.zip](attachment/10218/CURLLeak.zip)
10225|[Hello__world__and_PerfectTemplate_xcodeproj_and_CURLLeak_and_swiftroom.png](attachment/10225/Hello__world__and_PerfectTemplate_xcodeproj_and_CURLLeak_and_swiftroom.png)
10221|[Instruments2_and_Hello__world__and_cURL_swift_and_HipChat.png](attachment/10221/Instruments2_and_Hello__world__and_cURL_swift_and_HipChat.png)
10220|[Instruments2_and_Hello__world__and_cURL_swift_and_HipChat.png](attachment/10220/Instruments2_and_Hello__world__and_cURL_swift_and_HipChat.png)
10222|[Instruments4_and_Hello__world__and_main_swift_and_CURLLeak.png](attachment/10222/Instruments4_and_Hello__world__and_main_swift_and_CURLLeak.png)
10308|[Memory leaks 01.png](attachment/10308/Memory leaks 01.png)
10307|[Memory leaks 02.png](attachment/10307/Memory leaks 02.png)
10310|[Memory leaks 03.png](attachment/10310/Memory leaks 03.png)
10309|[Memory leaks 04.png](attachment/10309/Memory leaks 04.png)
10223|[PerfectTemplate_xcodeproj_and_Hello__world__and_CURLLeak.png](attachment/10223/PerfectTemplate_xcodeproj_and_Hello__world__and_CURLLeak.png)
10219|[Screen Shot 2016-11-01 at 4.24.04 PM.png](attachment/10219/Screen Shot 2016-11-01 at 4.24.04 PM.png)
10226|[Screen Shot 2016-11-02 at 3.28.39 PM.png](attachment/10226/Screen Shot 2016-11-02 at 3.28.39 PM.png)

